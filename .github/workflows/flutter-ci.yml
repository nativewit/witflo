name: Flutter CI - Spec-003 Phase 3

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'fyndo/**'
      - '.github/workflows/flutter-ci.yml'
  push:
    branches: [ main, develop ]
    paths:
      - 'fyndo/**'
      - '.github/workflows/flutter-ci.yml'

jobs:
  validate-flutter:
    name: Flutter Development Standards Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Setup
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        working-directory: ./fyndo
        run: flutter pub get

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 1: Code Formatting
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ Check code formatting
        working-directory: ./fyndo
        run: |
          echo "::group::Code Formatting"
          dart format --set-exit-if-changed lib/ test/
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 2: Static Analysis
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ” Run static analysis
        working-directory: ./fyndo
        run: |
          echo "::group::Static Analysis - Production Code"
          dart analyze lib/ --fatal-infos
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 3: Architecture Patterns
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ—ï¸ Validate architecture patterns
        working-directory: ./fyndo
        run: |
          echo "::group::Architecture Validation"
          # Check for built_value usage
          violations=$(grep -r "class.*State" lib/ --include="*.dart" | \
            grep -v "implements Built" | \
            grep -v "// Exception:" | \
            grep -v "ConsumerState\|State<\|StateNotifier\|AsyncNotifierProvider\|_\$" || echo "")
          
          if [ -n "$violations" ]; then
            echo "::warning::Found state classes not using built_value"
            echo "$violations"
          else
            echo "âœ… Architecture patterns are compliant"
          fi
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 4: Widget Keys Coverage
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”‘ Check widget keys coverage
        working-directory: ./fyndo
        run: |
          echo "::group::Widget Keys Coverage"
          missing_keys=$(grep -r "ElevatedButton\|TextButton\|IconButton\|TextField\|Checkbox\|Radio\|Switch" lib/ui/ | \
                         grep -v "key:" | \
                         grep -v "FyndoKeys" | \
                         grep -v ".g.dart" | \
                         wc -l | tr -d ' ' || echo "0")
          echo "Interactive widgets without keys: $missing_keys"
          if [ "$missing_keys" -gt 15 ]; then
            echo "::warning::Found $missing_keys interactive widgets without keys. Target: <10"
          else
            echo "âœ… Widget key coverage is good ($missing_keys widgets without keys)"
          fi
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 5: Logging Patterns
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“‹ Check logging patterns
        working-directory: ./fyndo
        run: |
          echo "::group::Logging Patterns"
          if grep -r "print\|debugPrint" lib/ --include="*.dart" --exclude-dir="*.g.dart"; then
            echo "::error::Found print/debugPrint in production code. Use AppLogger instead."
            exit 1
          else
            echo "âœ… All logging uses AppLogger"
          fi
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 6: Build Runner (Generated Code)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ”¨ Generate code
        working-directory: ./fyndo
        run: |
          echo "::group::Code Generation"
          dart run build_runner build --delete-conflicting-outputs
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 7: Tests
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ§ª Run tests
        working-directory: ./fyndo
        run: |
          echo "::group::Running Tests"
          flutter test --coverage || true
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CHECK 8: Coverage Threshold (90%)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“Š Check test coverage
        working-directory: ./fyndo
        run: |
          echo "::group::Test Coverage"
          if [ -f "coverage/lcov.info" ]; then
            # Install lcov
            sudo apt-get update && sudo apt-get install -y lcov
            
            # Extract coverage percentage
            coverage_output=$(lcov --summary coverage/lcov.info 2>&1)
            coverage_pct=$(echo "$coverage_output" | grep "lines" | grep -o "[0-9.]*%" | head -1 | grep -o "[0-9.]*" || echo "0")
            
            echo "Current Coverage: ${coverage_pct}%"
            echo "Minimum Required: 90%"
            
            # Set output for PR comment
            echo "coverage=${coverage_pct}" >> $GITHUB_OUTPUT
            
            # Check threshold (allowing for decimal comparison)
            if (( $(echo "$coverage_pct < 90" | bc -l) )); then
              echo "::warning::Coverage ${coverage_pct}% is below 90% target"
            else
              echo "âœ… Coverage ${coverage_pct}% meets 90% minimum"
            fi
          else
            echo "::warning::Coverage file not generated"
          fi
          echo "::endgroup::"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # Report
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ğŸ“ˆ Upload coverage to Codecov (optional)
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./fyndo/coverage/lcov.info
          flags: unittests
          name: fyndo-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: âœ… Validation Complete
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Flutter Development Standards Validation Complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Optional: Run on different platforms
  platform-tests:
    name: Platform Tests - ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    continue-on-error: true
    
    strategy:
      matrix:
        include:
          - platform: macOS
            os: macos-latest
          - platform: Windows
            os: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install dependencies
        working-directory: ./fyndo
        run: flutter pub get

      - name: ğŸ§ª Run tests on ${{ matrix.platform }}
        working-directory: ./fyndo
        run: flutter test
